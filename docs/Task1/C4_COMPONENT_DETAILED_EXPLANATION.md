# Task 1: Component Diagram - ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğµ Ğ¾Ğ±ÑŠÑÑĞ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹

## ğŸ¯ Ğ¦ĞµĞ»ÑŒ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹

Component Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Task 1 Ğ´ĞµĞ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ **Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ñ… ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²** Ñ„ĞµĞ´ĞµÑ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ GraphQL ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Auto.ru. Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° ÑĞ»ÑƒĞ¶Ğ¸Ñ‚ Ğ¼Ğ¾ÑÑ‚Ğ¾Ğ¼ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğ¼ Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½Ğ¾Ğ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ² Ğ¸ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ¹ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ², ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ¸ Ğ¼Ğ¾Ğ´ÑƒĞ»ĞµĞ¹, Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ ĞºĞ°Ğº ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ²Ğ¾Ğ¿Ğ»Ğ¾Ñ‰Ğ°ĞµÑ‚ÑÑ Ğ² Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼Ñ‹Ğ¹ ĞºĞ¾Ğ´.

## ğŸ—ï¸ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ¸ Ğ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

### 1. Cargo Workspace - Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¾Ğ¼

#### Workspace Config - Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ**: Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ¸ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑĞ¼Ğ¸
**Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**:`
``toml
# Cargo.toml - ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° workspace
[workspace]
members = [
    "crates/apollo-router",    # Ğ¤ĞµĞ´ĞµÑ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€
    "crates/ugc-subgraph",     # Ğ”Ğ¾Ğ¼ĞµĞ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ°
    "crates/users-subgraph",   # Ğ”Ğ¾Ğ¼ĞµĞ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    "crates/offers-subgraph",  # Ğ”Ğ¾Ğ¼ĞµĞ½ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ğ¹
    "crates/shared",           # ĞĞ±Ñ‰Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹
]
resolver = "2"

# ĞĞ±Ñ‰Ğ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… ĞºÑ€ĞµĞ¹Ñ‚Ğ¾Ğ² (DRY Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿)
[workspace.dependencies]
async-graphql = { version = "7.0", features = ["tracing", "apollo_tracing"] }
tokio = { version = "1.0", features = ["full"] }
axum = { version = "0.7", features = ["tracing"] }
sqlx = { version = "0.7", features = ["postgres", "uuid", "chrono"] }
redis = { version = "0.24", features = ["tokio-comp"] }
serde = { version = "1.0", features = ["derive"] }
uuid = { version = "1.0", features = ["v4", "serde"] }
tracing = "0.1"
prometheus = "0.13"

# ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸ ÑĞ±Ğ¾Ñ€ĞºĞ¸ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğ¹
[profile.dev]
debug = true
opt-level = 0
incremental = true

[profile.release]
debug = false
opt-level = 3
lto = true
codegen-units = 1
panic = "abort"
```

**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹ Ğ² Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸**:
- **ĞœĞ¾Ğ´ÑƒĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ**: Ğ Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ° Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ñ‹Ğµ ĞºÑ€ĞµĞ¹Ñ‚Ñ‹ Ğ¿Ğ¾ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ°Ğ¼
- **ĞŸĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ**: ĞĞ±Ñ‰Ğ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ² workspace.dependencies
- **ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**: Ğ Ğ°Ğ·Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ dev/release Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğ¹

### 2. Shared Crate - ĞĞ±Ñ‰Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹

#### Common Types - Ğ¢Ğ¸Ğ¿Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ñ‹
**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ**: Type safety Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº ÑĞ¼ĞµÑˆĞ¸Ğ²Ğ°Ğ½Ğ¸Ñ ID
**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ² ĞºĞ¾Ğ´Ğµ**:
```rust
// crates/shared/src/types.rs
use async_graphql::*;
use serde::{Deserialize, Serialize};
use std::fmt::{self, Display};

/// Ğ¢Ğ¸Ğ¿Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ¿ÑƒÑ‚Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼Ğ¸ ID
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]
pub struct UserId(pub uuid::Uuid);

impl UserId {
    pub fn new() -> Self {
        Self(uuid::Uuid::new_v4())
    }
    
    pub fn from_str(s: &str) -> Result<Self, uuid::Error> {
        Ok(Self(uuid::Uuid::parse_str(s)?))
    }
}

impl Display for UserId {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        write!(f, "{}", self.0)
    }
}

#[Scalar]
impl ScalarType for UserId {
    fn parse(value: Value) -> InputValueResult<Self> {
        match value {
            Value::String(s) => {
                Self::from_str(&s).map_err(|_| InputValueError::custom("Invalid UUID format"))
            }
            _ => Err(InputValueError::expected_type(value)),
        }
    }

    fn to_value(&self) -> Value {
        Value::String(self.to_string())
    }
}

/// ĞĞ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ´Ğ¾Ğ¼ĞµĞ½Ğ½Ñ‹Ñ… ID
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]
pub struct OfferId(pub uuid::Uuid);

#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]
pub struct ReviewId(pub uuid::Uuid);

// Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ñ‚Ñ€ĞµĞ¹Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ OfferId Ğ¸ ReviewId...
```

#### Auth Utils - Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ**: Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ² ĞºĞ¾Ğ´Ğµ**:
```rust
// crates/shared/src/auth.rs
use jsonwebtoken::{decode, encode, DecodingKey, EncodingKey, Header, Validation};
use serde::{Deserialize, Serialize};
use std::time::{SystemTime, UNIX_EPOCH};

#[derive(Debug, Serialize, Deserialize)]
pub struct Claims {
    pub sub: String,        // Subject (user ID)
    pub exp: usize,         // Expiration time
    pub iat: usize,         // Issued at
    pub roles: Vec<String>, // User roles
}

#[derive(Clone)]
pub struct JwtService {
    encoding_key: EncodingKey,
    decoding_key: DecodingKey,
    validation: Validation,
}

impl JwtService {
    pub fn new(secret: &str) -> Self {
        let encoding_key = EncodingKey::from_secret(secret.as_ref());
        let decoding_key = DecodingKey::from_secret(secret.as_ref());
        let validation = Validation::default();
        
        Self {
            encoding_key,
            decoding_key,
            validation,
        }
    }
    
    pub fn create_token(&self, user_id: &str, roles: Vec<String>) -> Result<String, AuthError> {
        let now = SystemTime::now().duration_since(UNIX_EPOCH)?.as_secs() as usize;
        
        let claims = Claims {
            sub: user_id.to_string(),
            exp: now + 3600, // 1 hour
            iat: now,
            roles,
        };
        
        encode(&Header::default(), &claims, &self.encoding_key)
            .map_err(AuthError::JwtError)
    }
    
    pub fn validate_token(&self, token: &str) -> Result<Claims, AuthError> {
        decode::<Claims>(token, &self.decoding_key, &self.validation)
            .map(|data| data.claims)
            .map_err(AuthError::JwtError)
    }
}

#[derive(Debug, thiserror::Error)]
pub enum AuthError {
    #[error("JWT error: {0}")]
    JwtError(#[from] jsonwebtoken::errors::Error),
    #[error("System time error: {0}")]
    SystemTimeError(#[from] std::time::SystemTimeError),
}
```

#### Error Handling - Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ**: Ğ•Ğ´Ğ¸Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ²Ğ¾ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ñ…
**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ² ĞºĞ¾Ğ´Ğµ**:
```rust
// crates/shared/src/errors.rs
use async_graphql::{ErrorExtensions, Result as GraphQLResult};
use thiserror::Error;

/// Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ´Ğ³Ñ€Ğ°Ñ„Ğ¾Ğ²
#[derive(Error, Debug)]
pub enum UgcError {
    #[error("Database error: {0}")]
    Database(#[from] sqlx::Error),
    
    #[error("Redis error: {0}")]
    Redis(#[from] redis::RedisError),
    
    #[error("Authentication error: {0}")]
    Auth(#[from] crate::auth::AuthError),
    
    #[error("Validation error: {message}")]
    Validation { message: String },
    
    #[error("Not found: {resource}")]
    NotFound { resource: String },
    
    #[error("Permission denied")]
    PermissionDenied,
    
    #[error("Internal server error")]
    Internal,
}

impl ErrorExtensions for UgcError {
    fn extend(&self) -> async_graphql::Error {
        let mut error = async_graphql::Error::new(self.to_string());
        
        match self {
            UgcError::Validation { .. } => {
                error = error.extend_with(|_, e| e.set("code", "VALIDATION_ERROR"));
            }
            UgcError::NotFound { .. } => {
                error = error.extend_with(|_, e| e.set("code", "NOT_FOUND"));
            }
            UgcError::PermissionDenied => {
                error = error.extend_with(|_, e| e.set("code", "PERMISSION_DENIED"));
            }
            UgcError::Auth(_) => {
                error = error.extend_with(|_, e| e.set("code", "AUTHENTICATION_ERROR"));
            }
            _ => {
                error = error.extend_with(|_, e| e.set("code", "INTERNAL_ERROR"));
            }
        }
        
        error
    }
}

/// ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚ĞµÑ€ Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² GraphQL Ñ€ĞµĞ·Ğ¾Ğ»Ğ²ĞµÑ€Ğ°Ñ…
pub type Result<T> = std::result::Result<T, UgcError>;
```

### 3. Apollo Router Crate - Ğ¤ĞµĞ´ĞµÑ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€

#### Router Config - ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ñ„ĞµĞ´ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ**: ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸ Ñ„ĞµĞ´ĞµÑ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑ‚Ğ¸
**Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**:
```yaml
# router.yaml - ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€Ğ°
supergraph:
  listen: 0.0.0.0:4000
  introspection: true
  
# CORS ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²ĞµĞ±-ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²
cors:
  origins:
    - http://localhost:3000
    - https://auto.ru
  allow_credentials: true
  allow_headers:
    - authorization
    - content-type
    - x-apollo-tracing

# Ğ¢ĞµĞ»ĞµĞ¼ĞµÑ‚Ñ€Ğ¸Ñ Ğ¸ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³
telemetry:
  instrumentation:
    spans:
      mode: spec_compliant
      default_attribute_requirement_level: required
  exporters:
    metrics:
      prometheus:
        enabled: true
        listen: 0.0.0.0:9090
        path: /metrics
    tracing:
      jaeger:
        endpoint: http://jaeger:14268/api/traces
        batch_processor:
          max_export_batch_size: 512
          max_queue_size: 2048

# ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ´Ğ³Ñ€Ğ°Ñ„Ğ¾Ğ² Ñ retry Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°Ğ¼Ğ¸
subgraphs:
  ugc:
    routing_url: http://ugc-subgraph:4001/graphql
    retry:
      min_per_sec: 10
      ttl: 10s
      retry_percent: 0.2
    timeout: 30s
    
  users:
    routing_url: http://users-subgraph:4002/graphql
    retry:
      min_per_sec: 10
      ttl: 10s
      retry_percent: 0.2
    timeout: 30s
    
  offers:
    routing_url: http://offers-subgraph:4003/graphql
    retry:
      min_per_sec: 10
      ttl: 10s
      retry_percent: 0.2
    timeout: 30s

# ĞšĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
query_planning:
  cache:
    in_memory:
      limit: 512
```

#### Supergraph Schema - ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ½Ğ°Ñ ÑÑ…ĞµĞ¼Ğ°
**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ**: Ğ•Ğ´Ğ¸Ğ½Ğ°Ñ GraphQL ÑÑ…ĞµĞ¼Ğ° Ğ¸Ğ· Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ´Ğ³Ñ€Ğ°Ñ„Ğ¾Ğ²
**Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑÑ…ĞµĞ¼Ñ‹**:
```bash
#!/bin/bash
# scripts/generate-supergraph.sh - ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ ÑÑ…ĞµĞ¼Ñ‹

set -e

echo "ğŸ”§ Generating supergraph schema..."

# ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ´Ğ³Ñ€Ğ°Ñ„Ğ¾Ğ²
wait_for_subgraph() {
    local name=$1
    local url=$2
    local max_attempts=30
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        if curl -f -s "$url" > /dev/null 2>&1; then
            echo "âœ… $name is ready"
            return 0
        fi
        echo "â³ Waiting for $name (attempt $attempt/$max_attempts)..."
        sleep 2
        ((attempt++))
    done
    
    echo "âŒ $name failed to start"
    return 1
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ´Ğ³Ñ€Ğ°Ñ„Ğ¾Ğ²
wait_for_subgraph "UGC Subgraph" "http://localhost:4001/health"
wait_for_subgraph "Users Subgraph" "http://localhost:4002/health"
wait_for_subgraph "Offers Subgraph" "http://localhost:4003/health"

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ rover
cat > supergraph-config.yaml << EOF
federation_version: =2.5.7
subgraphs:
  ugc:
    routing_url: http://ugc-subgraph:4001/graphql
    schema:
      subgraph_url: http://localhost:4001/graphql
  users:
    routing_url: http://users-subgraph:4002/graphql
    schema:
      subgraph_url: http://localhost:4002/graphql
  offers:
    routing_url: http://offers-subgraph:4003/graphql
    schema:
      subgraph_url: http://localhost:4003/graphql
EOF

# ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ ÑÑƒĞ¿ĞµÑ€-ÑÑ…ĞµĞ¼Ñ‹ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ Apollo Rover
rover supergraph compose --config supergraph-config.yaml > supergraph.graphql

echo "âœ… Supergraph schema generated successfully"
echo "ğŸ“„ Schema saved to supergraph.graphql"

# Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ÑÑ…ĞµĞ¼Ñ‹
rover graph check --schema supergraph.graphql || {
    echo "âš ï¸  Schema validation warnings (non-critical)"
}

echo "ğŸš€ Ready to start Apollo Router"
```

### 4. Docker Infrastructure - ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

#### Docker Compose - ĞÑ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ**: Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¼ Ñ†Ğ¸ĞºĞ»Ğ¾Ğ¼ Ğ²ÑĞµÑ… ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²
**Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**:
```yaml
# docker-compose.yml - ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¾Ñ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
version: '3.8'

# ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ ÑĞµÑ‚ĞµĞ¹ Ğ´Ğ»Ñ ÑĞµĞ³Ğ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸ Ñ‚Ñ€Ğ°Ñ„Ğ¸ĞºĞ°
networks:
  federation-network:
    driver: bridge
    name: autoru-federation
  data-network:
    driver: bridge
    internal: true
    name: autoru-data
  monitoring-network:
    driver: bridge
    name: autoru-monitoring

# ĞŸĞµÑ€ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ñ‹Ğµ Ñ‚Ğ¾Ğ¼Ğ° Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
volumes:
  postgres_data:
    driver: local
    name: autoru_postgres_data
  redis_data:
    driver: local
    name: autoru_redis_data
  prometheus_data:
    driver: local
    name: autoru_prometheus_data

services:
  # Ğ‘Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ÑÑ‚ÑÑ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼Ğ¸)
  postgres:
    image: postgres:15-alpine
    container_name: autoru_postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-autoru}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - data-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-autoru}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: autoru_redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis_password}
    volumes:
      - redis_data:/data
    networks:
      - data-network
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-redis_password}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # ĞŸĞ¾Ğ´Ğ³Ñ€Ğ°Ñ„Ñ‹ (Ğ·Ğ°Ğ²Ğ¸ÑÑÑ‚ Ğ¾Ñ‚ Ğ‘Ğ”)
  ugc-subgraph:
    build:
      context: .
      dockerfile: crates/ugc-subgraph/Dockerfile
      target: runtime
    container_name: autoru_ugc_subgraph
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-autoru}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_password}@redis:6379
      RUST_LOG: ${RUST_LOG:-info}
      JAEGER_ENDPOINT: http://jaeger:14268/api/traces
    networks:
      - federation-network
      - data-network
      - monitoring-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Apollo Router (Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ´Ğ³Ñ€Ğ°Ñ„Ğ¾Ğ²)
  apollo-router:
    build:
      context: .
      dockerfile: crates/apollo-router/Dockerfile
    container_name: autoru_apollo_router
    ports:
      - "${APOLLO_ROUTER_PORT:-4000}:4000"
      - "${APOLLO_ROUTER_METRICS_PORT:-9090}:9090"
    environment:
      APOLLO_ROUTER_CONFIG_PATH: /app/router.yaml
      APOLLO_ROUTER_SUPERGRAPH_PATH: /app/supergraph.graphql
      RUST_LOG: ${RUST_LOG:-info}
    volumes:
      - ./router.yaml:/app/router.yaml:ro
      - ./supergraph.graphql:/app/supergraph.graphql:ro
    networks:
      - federation-network
      - monitoring-network
    depends_on:
      ugc-subgraph:
        condition: service_healthy
      users-subgraph:
        condition: service_healthy
      offers-subgraph:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³
  prometheus:
    image: prom/prometheus:latest
    container_name: autoru_prometheus
    ports:
      - "${PROMETHEUS_PORT:-9091}:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - monitoring-network
      - federation-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    restart: unless-stopped

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: autoru_jaeger
    ports:
      - "${JAEGER_UI_PORT:-16686}:16686"
    environment:
      COLLECTOR_OTLP_ENABLED: true
    networks:
      - monitoring-network
      - federation-network
    restart: unless-stopped
```

### 5. Development Tools - ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸

#### Makefile - ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ**: Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ²ÑĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
**Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**:
```makefile
# Makefile - ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
.PHONY: help dev build test clean docker-build docker-up docker-down logs

# ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
RUST_LOG ?= info
COMPOSE_FILE ?= docker-compose.yml

help: ## ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ñ€Ğ°Ğ²ĞºÑƒ Ğ¿Ğ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°Ğ¼
	@echo "Auto.ru GraphQL Federation - Development Commands"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

dev: ## Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ÑÑ€ĞµĞ´Ñƒ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
	@echo "ğŸš€ Starting development environment..."
	@./scripts/dev-setup.sh

build: ## Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Rust Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñ‹
	@echo "ğŸ”¨ Building Rust workspace..."
	@cargo build --workspace

test: ## Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹
	@echo "ğŸ§ª Running tests..."
	@cargo test --workspace

clean: ## ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ ÑĞ±Ğ¾Ñ€ĞºĞ¸
	@echo "ğŸ§¹ Cleaning build artifacts..."
	@cargo clean
	@docker system prune -f

docker-build: ## Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹
	@echo "ğŸ³ Building Docker images..."
	@docker-compose -f $(COMPOSE_FILE) build

docker-up: ## Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Docker ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
	@echo "ğŸš€ Starting Docker containers..."
	@docker-compose -f $(COMPOSE_FILE) up -d

docker-down: ## ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Docker ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
	@echo "ğŸ›‘ Stopping Docker containers..."
	@docker-compose -f $(COMPOSE_FILE) down

logs: ## ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
	@docker-compose -f $(COMPOSE_FILE) logs -f

# Ğ¡Ğ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
generate-schema: ## Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ supergraph ÑÑ…ĞµĞ¼Ñƒ
	@echo "ğŸ“‹ Generating supergraph schema..."
	@./scripts/generate-supergraph.sh

migrate: ## Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ‘Ğ”
	@echo "ğŸ—„ï¸ Running database migrations..."
	@docker-compose exec postgres psql -U postgres -d autoru -f /docker-entrypoint-initdb.d/001_initial_schema.sql

reset-db: ## Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
	@echo "ğŸ”„ Resetting database..."
	@docker-compose down postgres
	@docker volume rm autoru_postgres_data || true
	@docker-compose up -d postgres

health-check: ## ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
	@echo "ğŸ¥ Checking system health..."
	@./scripts/health-check.sh

# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
integration-test: ## Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹
	@echo "ğŸ”— Running integration tests..."
	@cargo test --test integration_tests

load-test: ## Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹
	@echo "âš¡ Running load tests..."
	@./scripts/load-test.sh

# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ´Ğ»Ñ production
prod-build: ## Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ´Ğ»Ñ production
	@echo "ğŸ­ Building for production..."
	@cargo build --release --workspace

prod-docker: ## Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ production Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹
	@echo "ğŸ³ Building production Docker images..."
	@docker-compose -f docker-compose.prod.yml build
```

#### Environment Config - ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ**: Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
**Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**:
```bash
# .env.example - Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
# Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ² .env Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ´ ÑĞ²Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ

# === Database Configuration ===
POSTGRES_DB=autoru
POSTGRES_USER=postgres
POSTGRES_PASSWORD=secure_password_here
DATABASE_URL=postgresql://postgres:secure_password_here@localhost:5432/autoru

# === Redis Configuration ===
REDIS_PASSWORD=redis_secure_password
REDIS_URL=redis://:redis_secure_password@localhost:6379

# === JWT Configuration ===
JWT_SECRET=your_super_secret_jwt_key_here_minimum_32_characters
JWT_EXPIRATION=3600

# === Service Ports ===
APOLLO_ROUTER_PORT=4000
APOLLO_ROUTER_METRICS_PORT=9090
UGC_SUBGRAPH_PORT=4001
USERS_SUBGRAPH_PORT=4002
OFFERS_SUBGRAPH_PORT=4003

# === Monitoring Ports ===
PROMETHEUS_PORT=9091
JAEGER_UI_PORT=16686

# === Logging Configuration ===
RUST_LOG=info
# Ğ”Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ: RUST_LOG=debug
# Ğ”Ğ»Ñ production: RUST_LOG=warn

# === Development Settings ===
RUST_BACKTRACE=1
CARGO_INCREMENTAL=1

# === Feature Flags ===
ENABLE_INTROSPECTION=true
ENABLE_PLAYGROUND=true
ENABLE_TRACING=true
ENABLE_METRICS=true

# === External Services ===
ELASTICSEARCH_URL=http://localhost:9200
KIBANA_URL=http://localhost:5601

# === Security Settings ===
CORS_ORIGINS=http://localhost:3000,https://auto.ru
RATE_LIMIT_REQUESTS_PER_MINUTE=100
SESSION_TIMEOUT_MINUTES=60
```

## ğŸ”„ ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ½Ñ‹Ğµ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¸ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸

### Ğ“Ñ€Ğ°Ñ„ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²
```mermaid
graph TD
    A[Workspace Config] --> B[Shared Crate]
    A --> C[Apollo Router Crate]
    A --> D[Subgraph Crates]
    
    B --> E[Common Types]
    B --> F[Auth Utils]
    B --> G[Error Handling]
    B --> H[Common Utils]
    
    C --> I[Router Config]
    C --> J[Supergraph Schema]
    C --> K[Router Dockerfile]
    
    D --> L[UGC Dockerfile]
    D --> M[Users Dockerfile]
    D --> N[Offers Dockerfile]
    
    O[Docker Compose] --> P[PostgreSQL Service]
    O --> Q[Redis Service]
    O --> C
    O --> D
    
    R[Makefile] --> S[Dev Setup Script]
    R --> T[Health Check Script]
    R --> O
    
    U[Environment Config] --> O
    U --> C
    U --> D
```

### Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
```
auto-ru-graphql-federation/
â”œâ”€â”€ Cargo.toml                 # Workspace ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
â”œâ”€â”€ docker-compose.yml         # ĞÑ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
â”œâ”€â”€ Makefile                   # ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´
â”œâ”€â”€ .env.example              # Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
â”œâ”€â”€ router.yaml               # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Apollo Router
â”œâ”€â”€ supergraph.graphql        # ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ½Ğ°Ñ ÑÑ…ĞµĞ¼Ğ°
â”œâ”€â”€ prometheus.yml            # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ°
â”œâ”€â”€ crates/
â”‚   â”œâ”€â”€ shared/               # ĞĞ±Ñ‰Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ lib.rs        # Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°
â”‚   â”‚       â”œâ”€â”€ types.rs      # Ğ¢Ğ¸Ğ¿Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ID
â”‚   â”‚       â”œâ”€â”€ auth.rs       # JWT ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹
â”‚   â”‚       â”œâ”€â”€ errors.rs     # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
â”‚   â”‚       â””â”€â”€ utils.rs      # Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
â”‚   â”œâ”€â”€ apollo-router/        # Ğ¤ĞµĞ´ĞµÑ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â””â”€â”€ src/main.rs
â”‚   â”œâ”€â”€ ugc-subgraph/         # UGC Ğ¿Ğ¾Ğ´Ğ³Ñ€Ğ°Ñ„
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”œâ”€â”€ users-subgraph/       # Users Ğ¿Ğ¾Ğ´Ğ³Ñ€Ğ°Ñ„
â”‚   â””â”€â”€ offers-subgraph/      # Offers Ğ¿Ğ¾Ğ´Ğ³Ñ€Ğ°Ñ„
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ dev-setup.sh          # ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° ÑÑ€ĞµĞ´Ñ‹
â”‚   â”œâ”€â”€ dev-stop.sh           # ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
â”‚   â”œâ”€â”€ generate-supergraph.sh # Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑÑ…ĞµĞ¼Ñ‹
â”‚   â””â”€â”€ health-check.sh       # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ
â””â”€â”€ migrations/
    â””â”€â”€ 001_initial_schema.sql # Ğ¡Ñ…ĞµĞ¼Ğ° Ğ‘Ğ”
```

Ğ­Ñ‚Ğ° Component Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ´ĞµĞ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ°Ğº Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Task 1 Ğ²Ğ¾Ğ¿Ğ»Ğ¾Ñ‰Ğ°ÑÑ‚ÑÑ Ğ² ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹, ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ğ¼Ğ¾Ğ´ÑƒĞ»Ğ¸, Ğ¾Ğ±ĞµÑĞ¿ĞµÑ‡Ğ¸Ğ²Ğ°Ñ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ, Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ° Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ² Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸.