# Task 1: Component Diagram - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

## üéØ –¶–µ–ª—å –¥–∏–∞–≥—Ä–∞–º–º—ã

Component –¥–∏–∞–≥—Ä–∞–º–º–∞ Task 1 –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç **–¥–µ—Ç–∞–ª—å–Ω—É—é –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤** —Ñ–µ–¥–µ—Ä–∞—Ç–∏–≤–Ω–æ–π GraphQL —Å–∏—Å—Ç–µ–º—ã Auto.ru. –î–∏–∞–≥—Ä–∞–º–º–∞ —Å–ª—É–∂–∏—Ç –º–æ—Å—Ç–æ–º –º–µ–∂–¥—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π —Ñ–∞–π–ª–æ–≤, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∏ –º–æ–¥—É–ª–µ–π, –ø–æ–∫–∞–∑—ã–≤–∞—è –∫–∞–∫ –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤–æ–ø–ª–æ—â–∞–µ—Ç—Å—è –≤ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π –∫–æ–¥.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∏—Ö —Ñ–∞–π–ª–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. Cargo Workspace - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–º

#### Workspace Config - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
**–§–∞–π–ª–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**:`
``toml
# Cargo.toml - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ workspace
[workspace]
members = [
    "crates/apollo-router",    # –§–µ–¥–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä
    "crates/ugc-subgraph",     # –î–æ–º–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    "crates/users-subgraph",   # –î–æ–º–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    "crates/offers-subgraph",  # –î–æ–º–µ–Ω –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    "crates/shared",           # –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
]
resolver = "2"

# –û–±—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ—Ö –∫—Ä–µ–π—Ç–æ–≤ (DRY –ø—Ä–∏–Ω—Ü–∏–ø)
[workspace.dependencies]
async-graphql = { version = "7.0", features = ["tracing", "apollo_tracing"] }
tokio = { version = "1.0", features = ["full"] }
axum = { version = "0.7", features = ["tracing"] }
sqlx = { version = "0.7", features = ["postgres", "uuid", "chrono"] }
redis = { version = "0.24", features = ["tokio-comp"] }
serde = { version = "1.0", features = ["derive"] }
uuid = { version = "1.0", features = ["v4", "serde"] }
tracing = "0.1"
prometheus = "0.13"

# –ü—Ä–æ—Ñ–∏–ª–∏ —Å–±–æ—Ä–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π
[profile.dev]
debug = true
opt-level = 0
incremental = true

[profile.release]
debug = false
opt-level = 3
lto = true
codegen-units = 1
panic = "abort"
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**:
- **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å**: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∫—Ä–µ–π—Ç—ã –ø–æ –¥–æ–º–µ–Ω–∞–º
- **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –û–±—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ workspace.dependencies
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –†–∞–∑–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –¥–ª—è dev/release –æ–∫—Ä—É–∂–µ–Ω–∏–π

### 2. Shared Crate - –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### Common Types - –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: Type safety –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ —Å–º–µ—à–∏–≤–∞–Ω–∏—è ID
**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ –∫–æ–¥–µ**:
```rust
// crates/shared/src/types.rs
use async_graphql::*;
use serde::{Deserialize, Serialize};
use std::fmt::{self, Display};

/// –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—É—Ç–∞–Ω–∏—Ü—ã —Å –¥—Ä—É–≥–∏–º–∏ ID
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]
pub struct UserId(pub uuid::Uuid);

impl UserId {
    pub fn new() -> Self {
        Self(uuid::Uuid::new_v4())
    }
    
    pub fn from_str(s: &str) -> Result<Self, uuid::Error> {
        Ok(Self(uuid::Uuid::parse_str(s)?))
    }
}

impl Display for UserId {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        write!(f, "{}", self.0)
    }
}

#[Scalar]
impl ScalarType for UserId {
    fn parse(value: Value) -> InputValueResult<Self> {
        match value {
            Value::String(s) => {
                Self::from_str(&s).map_err(|_| InputValueError::custom("Invalid UUID format"))
            }
            _ => Err(InputValueError::expected_type(value)),
        }
    }

    fn to_value(&self) -> Value {
        Value::String(self.to_string())
    }
}

/// –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –¥—Ä—É–≥–∏—Ö –¥–æ–º–µ–Ω–Ω—ã—Ö ID
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]
pub struct OfferId(pub uuid::Uuid);

#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]
pub struct ReviewId(pub uuid::Uuid);

// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö —Ç—Ä–µ–π—Ç–æ–≤ –¥–ª—è OfferId –∏ ReviewId...
```

#### Auth Utils - –£—Ç–∏–ª–∏—Ç—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ –∫–æ–¥–µ**:
```rust
// crates/shared/src/auth.rs
use jsonwebtoken::{decode, encode, DecodingKey, EncodingKey, Header, Validation};
use serde::{Deserialize, Serialize};
use std::time::{SystemTime, UNIX_EPOCH};

#[derive(Debug, Serialize, Deserialize)]
pub struct Claims {
    pub sub: String,        // Subject (user ID)
    pub exp: usize,         // Expiration time
    pub iat: usize,         // Issued at
    pub roles: Vec<String>, // User roles
}

#[derive(Clone)]
pub struct JwtService {
    encoding_key: EncodingKey,
    decoding_key: DecodingKey,
    validation: Validation,
}

impl JwtService {
    pub fn new(secret: &str) -> Self {
        let encoding_key = EncodingKey::from_secret(secret.as_ref());
        let decoding_key = DecodingKey::from_secret(secret.as_ref());
        let validation = Validation::default();
        
        Self {
            encoding_key,
            decoding_key,
            validation,
        }
    }
    
    pub fn create_token(&self, user_id: &str, roles: Vec<String>) -> Result<String, AuthError> {
        let now = SystemTime::now().duration_since(UNIX_EPOCH)?.as_secs() as usize;
        
        let claims = Claims {
            sub: user_id.to_string(),
            exp: now + 3600, // 1 hour
            iat: now,
            roles,
        };
        
        encode(&Header::default(), &claims, &self.encoding_key)
            .map_err(AuthError::JwtError)
    }
    
    pub fn validate_token(&self, token: &str) -> Result<Claims, AuthError> {
        decode::<Claims>(token, &self.decoding_key, &self.validation)
            .map(|data| data.claims)
            .map_err(AuthError::JwtError)
    }
}

#[derive(Debug, thiserror::Error)]
pub enum AuthError {
    #[error("JWT error: {0}")]
    JwtError(#[from] jsonwebtoken::errors::Error),
    #[error("System time error: {0}")]
    SystemTimeError(#[from] std::time::SystemTimeError),
}
```

#### Error Handling - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö
**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ –∫–æ–¥–µ**:
```rust
// crates/shared/src/errors.rs
use async_graphql::{ErrorExtensions, Result as GraphQLResult};
use thiserror::Error;

/// –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—à–∏–±–æ–∫ –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–≥—Ä–∞—Ñ–æ–≤
#[derive(Error, Debug)]
pub enum UgcError {
    #[error("Database error: {0}")]
    Database(#[from] sqlx::Error),
    
    #[error("Redis error: {0}")]
    Redis(#[from] redis::RedisError),
    
    #[error("Authentication error: {0}")]
    Auth(#[from] crate::auth::AuthError),
    
    #[error("Validation error: {message}")]
    Validation { message: String },
    
    #[error("Not found: {resource}")]
    NotFound { resource: String },
    
    #[error("Permission denied")]
    PermissionDenied,
    
    #[error("Internal server error")]
    Internal,
}

impl ErrorExtensions for UgcError {
    fn extend(&self) -> async_graphql::Error {
        let mut error = async_graphql::Error::new(self.to_string());
        
        match self {
            UgcError::Validation { .. } => {
                error = error.extend_with(|_, e| e.set("code", "VALIDATION_ERROR"));
            }
            UgcError::NotFound { .. } => {
                error = error.extend_with(|_, e| e.set("code", "NOT_FOUND"));
            }
            UgcError::PermissionDenied => {
                error = error.extend_with(|_, e| e.set("code", "PERMISSION_DENIED"));
            }
            UgcError::Auth(_) => {
                error = error.extend_with(|_, e| e.set("code", "AUTHENTICATION_ERROR"));
            }
            _ => {
                error = error.extend_with(|_, e| e.set("code", "INTERNAL_ERROR"));
            }
        }
        
        error
    }
}

/// –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ GraphQL —Ä–µ–∑–æ–ª–≤–µ—Ä–∞—Ö
pub type Result<T> = std::result::Result<T, UgcError>;
```

### 3. Apollo Router Crate - –§–µ–¥–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä

#### Router Config - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ñ–µ–¥–µ—Ä–∞—Ü–∏–∏
**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–ø–æ–ª–æ–≥–∏–∏ —Ñ–µ–¥–µ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å–µ—Ç–∏
**–§–∞–π–ª–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
```yaml
# router.yaml - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–∞
supergraph:
  listen: 0.0.0.0:4000
  introspection: true
  
# CORS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –≤–µ–±-–∫–ª–∏–µ–Ω—Ç–æ–≤
cors:
  origins:
    - http://localhost:3000
    - https://auto.ru
  allow_credentials: true
  allow_headers:
    - authorization
    - content-type
    - x-apollo-tracing

# –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
telemetry:
  instrumentation:
    spans:
      mode: spec_compliant
      default_attribute_requirement_level: required
  exporters:
    metrics:
      prometheus:
        enabled: true
        listen: 0.0.0.0:9090
        path: /metrics
    tracing:
      jaeger:
        endpoint: http://jaeger:14268/api/traces
        batch_processor:
          max_export_batch_size: 512
          max_queue_size: 2048

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥–≥—Ä–∞—Ñ–æ–≤ —Å retry –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏
subgraphs:
  ugc:
    routing_url: http://ugc-subgraph:4001/graphql
    retry:
      min_per_sec: 10
      ttl: 10s
      retry_percent: 0.2
    timeout: 30s
    
  users:
    routing_url: http://users-subgraph:4002/graphql
    retry:
      min_per_sec: 10
      ttl: 10s
      retry_percent: 0.2
    timeout: 30s
    
  offers:
    routing_url: http://offers-subgraph:4003/graphql
    retry:
      min_per_sec: 10
      ttl: 10s
      retry_percent: 0.2
    timeout: 30s

# –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
query_planning:
  cache:
    in_memory:
      limit: 512
```

#### Supergraph Schema - –ö–æ–º–ø–æ–∑–∏—Ç–Ω–∞—è —Å—Ö–µ–º–∞
**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: –ï–¥–∏–Ω–∞—è GraphQL —Å—Ö–µ–º–∞ –∏–∑ –≤—Å–µ—Ö –ø–æ–¥–≥—Ä–∞—Ñ–æ–≤
**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã**:
```bash
#!/bin/bash
# scripts/generate-supergraph.sh - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Å—Ö–µ–º—ã

set -e

echo "üîß Generating supergraph schema..."

# –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –ø–æ–¥–≥—Ä–∞—Ñ–æ–≤
wait_for_subgraph() {
    local name=$1
    local url=$2
    local max_attempts=30
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        if curl -f -s "$url" > /dev/null 2>&1; then
            echo "‚úÖ $name is ready"
            return 0
        fi
        echo "‚è≥ Waiting for $name (attempt $attempt/$max_attempts)..."
        sleep 2
        ((attempt++))
    done
    
    echo "‚ùå $name failed to start"
    return 1
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –ø–æ–¥–≥—Ä–∞—Ñ–æ–≤
wait_for_subgraph "UGC Subgraph" "http://localhost:4001/health"
wait_for_subgraph "Users Subgraph" "http://localhost:4002/health"
wait_for_subgraph "Offers Subgraph" "http://localhost:4003/health"

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è rover
cat > supergraph-config.yaml << EOF
federation_version: =2.5.7
subgraphs:
  ugc:
    routing_url: http://ugc-subgraph:4001/graphql
    schema:
      subgraph_url: http://localhost:4001/graphql
  users:
    routing_url: http://users-subgraph:4002/graphql
    schema:
      subgraph_url: http://localhost:4002/graphql
  offers:
    routing_url: http://offers-subgraph:4003/graphql
    schema:
      subgraph_url: http://localhost:4003/graphql
EOF

# –ö–æ–º–ø–æ–∑–∏—Ü–∏—è —Å—É–ø–µ—Ä-—Å—Ö–µ–º—ã —Å –ø–æ–º–æ—â—å—é Apollo Rover
rover supergraph compose --config supergraph-config.yaml > supergraph.graphql

echo "‚úÖ Supergraph schema generated successfully"
echo "üìÑ Schema saved to supergraph.graphql"

# –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º—ã
rover graph check --schema supergraph.graphql || {
    echo "‚ö†Ô∏è  Schema validation warnings (non-critical)"
}

echo "üöÄ Ready to start Apollo Router"
```

### 4. Docker Infrastructure - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è

#### Docker Compose - –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
**–§–∞–π–ª–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
```yaml
# docker-compose.yml - –ü–æ–ª–Ω–∞—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
version: '3.8'

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ç–µ–π –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
networks:
  federation-network:
    driver: bridge
    name: autoru-federation
  data-network:
    driver: bridge
    internal: true
    name: autoru-data
  monitoring-network:
    driver: bridge
    name: autoru-monitoring

# –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ —Ç–æ–º–∞ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
volumes:
  postgres_data:
    driver: local
    name: autoru_postgres_data
  redis_data:
    driver: local
    name: autoru_redis_data
  prometheus_data:
    driver: local
    name: autoru_prometheus_data

services:
  # –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏)
  postgres:
    image: postgres:15-alpine
    container_name: autoru_postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-autoru}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - data-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-autoru}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: autoru_redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis_password}
    volumes:
      - redis_data:/data
    networks:
      - data-network
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-redis_password}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # –ü–æ–¥–≥—Ä–∞—Ñ—ã (–∑–∞–≤–∏—Å—è—Ç –æ—Ç –ë–î)
  ugc-subgraph:
    build:
      context: .
      dockerfile: crates/ugc-subgraph/Dockerfile
      target: runtime
    container_name: autoru_ugc_subgraph
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-autoru}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_password}@redis:6379
      RUST_LOG: ${RUST_LOG:-info}
      JAEGER_ENDPOINT: http://jaeger:14268/api/traces
    networks:
      - federation-network
      - data-network
      - monitoring-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Apollo Router (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Å–µ—Ö –ø–æ–¥–≥—Ä–∞—Ñ–æ–≤)
  apollo-router:
    build:
      context: .
      dockerfile: crates/apollo-router/Dockerfile
    container_name: autoru_apollo_router
    ports:
      - "${APOLLO_ROUTER_PORT:-4000}:4000"
      - "${APOLLO_ROUTER_METRICS_PORT:-9090}:9090"
    environment:
      APOLLO_ROUTER_CONFIG_PATH: /app/router.yaml
      APOLLO_ROUTER_SUPERGRAPH_PATH: /app/supergraph.graphql
      RUST_LOG: ${RUST_LOG:-info}
    volumes:
      - ./router.yaml:/app/router.yaml:ro
      - ./supergraph.graphql:/app/supergraph.graphql:ro
    networks:
      - federation-network
      - monitoring-network
    depends_on:
      ugc-subgraph:
        condition: service_healthy
      users-subgraph:
        condition: service_healthy
      offers-subgraph:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
  prometheus:
    image: prom/prometheus:latest
    container_name: autoru_prometheus
    ports:
      - "${PROMETHEUS_PORT:-9091}:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - monitoring-network
      - federation-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    restart: unless-stopped

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: autoru_jaeger
    ports:
      - "${JAEGER_UI_PORT:-16686}:16686"
    environment:
      COLLECTOR_OTLP_ENABLED: true
    networks:
      - monitoring-network
      - federation-network
    restart: unless-stopped
```

### 5. Development Tools - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

#### Makefile - –ö–æ–º–∞–Ω–¥—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: –£–ø—Ä–æ—â–µ–Ω–∏–µ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞—á —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
**–§–∞–π–ª–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
```makefile
# Makefile - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
.PHONY: help dev build test clean docker-build docker-up docker-down logs

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
RUST_LOG ?= info
COMPOSE_FILE ?= docker-compose.yml

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
	@echo "Auto.ru GraphQL Federation - Development Commands"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

dev: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ä–µ–¥—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
	@echo "üöÄ Starting development environment..."
	@./scripts/dev-setup.sh

build: ## –°–æ–±—Ä–∞—Ç—å –≤—Å–µ Rust –ø—Ä–æ–µ–∫—Ç—ã
	@echo "üî® Building Rust workspace..."
	@cargo build --workspace

test: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
	@echo "üß™ Running tests..."
	@cargo test --workspace

clean: ## –û—á–∏—Å—Ç–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–±–æ—Ä–∫–∏
	@echo "üßπ Cleaning build artifacts..."
	@cargo clean
	@docker system prune -f

docker-build: ## –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑—ã
	@echo "üê≥ Building Docker images..."
	@docker-compose -f $(COMPOSE_FILE) build

docker-up: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
	@echo "üöÄ Starting Docker containers..."
	@docker-compose -f $(COMPOSE_FILE) up -d

docker-down: ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
	@echo "üõë Stopping Docker containers..."
	@docker-compose -f $(COMPOSE_FILE) down

logs: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
	@docker-compose -f $(COMPOSE_FILE) logs -f

# –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
generate-schema: ## –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å supergraph —Å—Ö–µ–º—É
	@echo "üìã Generating supergraph schema..."
	@./scripts/generate-supergraph.sh

migrate: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
	@echo "üóÑÔ∏è Running database migrations..."
	@docker-compose exec postgres psql -U postgres -d autoru -f /docker-entrypoint-initdb.d/001_initial_schema.sql

reset-db: ## –°–±—Ä–æ—Å–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
	@echo "üîÑ Resetting database..."
	@docker-compose down postgres
	@docker volume rm autoru_postgres_data || true
	@docker-compose up -d postgres

health-check: ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
	@echo "üè• Checking system health..."
	@./scripts/health-check.sh

# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
integration-test: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
	@echo "üîó Running integration tests..."
	@cargo test --test integration_tests

load-test: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã
	@echo "‚ö° Running load tests..."
	@./scripts/load-test.sh

# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è production
prod-build: ## –°–æ–±—Ä–∞—Ç—å –¥–ª—è production
	@echo "üè≠ Building for production..."
	@cargo build --release --workspace

prod-docker: ## –°–æ–±—Ä–∞—Ç—å production Docker –æ–±—Ä–∞–∑—ã
	@echo "üê≥ Building production Docker images..."
	@docker-compose -f docker-compose.prod.yml build
```

#### Environment Config - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
**–§–∞–π–ª–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
```bash
# .env.example - –®–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ .env –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥ —Å–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

# === Database Configuration ===
POSTGRES_DB=autoru
POSTGRES_USER=postgres
POSTGRES_PASSWORD=secure_password_here
DATABASE_URL=postgresql://postgres:secure_password_here@localhost:5432/autoru

# === Redis Configuration ===
REDIS_PASSWORD=redis_secure_password
REDIS_URL=redis://:redis_secure_password@localhost:6379

# === JWT Configuration ===
JWT_SECRET=your_super_secret_jwt_key_here_minimum_32_characters
JWT_EXPIRATION=3600

# === Service Ports ===
APOLLO_ROUTER_PORT=4000
APOLLO_ROUTER_METRICS_PORT=9090
UGC_SUBGRAPH_PORT=4001
USERS_SUBGRAPH_PORT=4002
OFFERS_SUBGRAPH_PORT=4003

# === Monitoring Ports ===
PROMETHEUS_PORT=9091
JAEGER_UI_PORT=16686

# === Logging Configuration ===
RUST_LOG=info
# –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: RUST_LOG=debug
# –î–ª—è production: RUST_LOG=warn

# === Development Settings ===
RUST_BACKTRACE=1
CARGO_INCREMENTAL=1

# === Feature Flags ===
ENABLE_INTROSPECTION=true
ENABLE_PLAYGROUND=true
ENABLE_TRACING=true
ENABLE_METRICS=true

# === External Services ===
ELASTICSEARCH_URL=http://localhost:9200
KIBANA_URL=http://localhost:5601

# === Security Settings ===
CORS_ORIGINS=http://localhost:3000,https://auto.ru
RATE_LIMIT_REQUESTS_PER_MINUTE=100
SESSION_TIMEOUT_MINUTES=60
```

## üîÑ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### –ì—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
```mermaid
graph TD
    A[Workspace Config] --> B[Shared Crate]
    A --> C[Apollo Router Crate]
    A --> D[Subgraph Crates]
    
    B --> E[Common Types]
    B --> F[Auth Utils]
    B --> G[Error Handling]
    B --> H[Common Utils]
    
    C --> I[Router Config]
    C --> J[Supergraph Schema]
    C --> K[Router Dockerfile]
    
    D --> L[UGC Dockerfile]
    D --> M[Users Dockerfile]
    D --> N[Offers Dockerfile]
    
    O[Docker Compose] --> P[PostgreSQL Service]
    O --> Q[Redis Service]
    O --> C
    O --> D
    
    R[Makefile] --> S[Dev Setup Script]
    R --> T[Health Check Script]
    R --> O
    
    U[Environment Config] --> O
    U --> C
    U --> D
```

### –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
auto-ru-graphql-federation/
‚îú‚îÄ‚îÄ Cargo.toml                 # Workspace –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ docker-compose.yml         # –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ Makefile                   # –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
‚îú‚îÄ‚îÄ .env.example              # –®–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ router.yaml               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Apollo Router
‚îú‚îÄ‚îÄ supergraph.graphql        # –ö–æ–º–ø–æ–∑–∏—Ç–Ω–∞—è —Å—Ö–µ–º–∞
‚îú‚îÄ‚îÄ prometheus.yml            # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
‚îú‚îÄ‚îÄ crates/
‚îÇ   ‚îú‚îÄ‚îÄ shared/               # –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Cargo.toml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ lib.rs        # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ types.rs      # –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ ID
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ auth.rs       # JWT —É—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ errors.rs     # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ utils.rs      # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ apollo-router/        # –§–µ–¥–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Cargo.toml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/main.rs
‚îÇ   ‚îú‚îÄ‚îÄ ugc-subgraph/         # UGC –ø–æ–¥–≥—Ä–∞—Ñ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Cargo.toml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ users-subgraph/       # Users –ø–æ–¥–≥—Ä–∞—Ñ
‚îÇ   ‚îî‚îÄ‚îÄ offers-subgraph/      # Offers –ø–æ–¥–≥—Ä–∞—Ñ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ dev-setup.sh          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ä–µ–¥—ã
‚îÇ   ‚îú‚îÄ‚îÄ dev-stop.sh           # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ generate-supergraph.sh # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã
‚îÇ   ‚îî‚îÄ‚îÄ health-check.sh       # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
‚îî‚îÄ‚îÄ migrations/
    ‚îî‚îÄ‚îÄ 001_initial_schema.sql # –°—Ö–µ–º–∞ –ë–î
```

–≠—Ç–∞ Component –¥–∏–∞–≥—Ä–∞–º–º–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –∫–∞–∫ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è Task 1 –≤–æ–ø–ª–æ—â–∞—é—Ç—Å—è –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –º–æ–¥—É–ª–∏, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –º–æ–¥—É–ª—å–Ω–æ—Å—Ç—å, –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.